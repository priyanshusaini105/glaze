generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

model Table {
  id                  String               @id @default(uuid())
  name                String
  description         String?
  userId              String?              // Supabase Auth user ID - optional for migration of existing tables
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  cellEnrichmentTasks CellEnrichmentTask[]
  columns             Column[]
  enrichmentJobs      EnrichmentJob[]
  rows                Row[]

  @@index([userId])
  @@map("tables")
}

model Column {
  id                  String               @id @default(uuid())
  tableId             String
  key                 String
  label               String
  dataType            String               @default("text")
  order               Int                  @default(0)
  config              Json?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  category            String?
  cellEnrichmentTasks CellEnrichmentTask[]
  table               Table                @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@unique([tableId, key])
  @@map("columns")
}

model Row {
  id                  String               @id @default(uuid())
  tableId             String
  data                Json
  status              RowStatus            @default(idle)
  confidence          Float?
  error               String?
  lastRunAt           DateTime?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  confidenceSum       Float                @default(0)
  doneTasks           Int                  @default(0)
  failedTasks         Int                  @default(0)
  runningTasks        Int                  @default(0)
  totalTasks          Int                  @default(0)
  enrichingColumns    String[]             @default([]) // Track which columns are currently enriching for realtime updates
  cellEnrichmentTasks CellEnrichmentTask[]
  table               Table                @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@index([tableId])
  @@index([tableId, createdAt])
  @@index([status])
  @@map("rows")
}

/// *
/// * EnrichmentJob - Tracks a batch enrichment request
/// * 
/// * Created when user triggers enrichment on cells/rows/columns.
/// * Contains metadata about the batch and links to individual cell tasks.
model EnrichmentJob {
  id          String               @id @default(uuid())
  tableId     String
  status      JobStatus            @default(pending)
  totalTasks  Int                  @default(0)
  doneTasks   Int                  @default(0)
  failedTasks Int                  @default(0)
  createdBy   String?
  error       String?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  cellTasks   CellEnrichmentTask[]
  table       Table                @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@index([tableId])
  @@index([status])
  @@map("enrichment_jobs")
}

/// *
/// * CellEnrichmentTask - The atomic unit of enrichment
/// * 
/// * Each task represents one (rowId, columnId) enrichment operation.
/// * Workers pick up queued tasks and execute them independently.
model CellEnrichmentTask {
  id          String         @id @default(uuid())
  tableId     String
  rowId       String
  columnId    String
  jobId       String
  status      CellTaskStatus @default(queued)
  result      Json?
  confidence  Float?
  error       String?
  attempts    Int            @default(0)
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  column      Column         @relation(fields: [columnId], references: [id], onDelete: Cascade)
  job         EnrichmentJob  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  row         Row            @relation(fields: [rowId], references: [id], onDelete: Cascade)
  table       Table          @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@unique([jobId, rowId, columnId])
  @@index([jobId])
  @@index([status])
  @@index([rowId])
  @@index([columnId])
  @@map("cell_enrichment_tasks")
}

enum RowStatus {
  idle
  queued
  running
  done
  failed
  ambiguous
}

enum CellTaskStatus {
  queued
  running
  done
  failed
}

enum JobStatus {
  pending
  running
  completed
  failed
  cancelled
}
